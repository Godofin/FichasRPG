<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha Ordem Paranormal - Completa</title>
    <!-- html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Special+Elite&family=Roboto+Condensed:wght@400;700&display=swap');

        :root {
            --bg-body: #333;
            --paper-bg: #fdfdfd;
            --ink-color: #111;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-body);
            font-family: 'Roboto Condensed', sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* BARRA DE CONTROLE */
        .control-bar {
            width: 100%; max-width: 210mm; margin-bottom: 20px;
            display: flex; gap: 10px; justify-content: center;
            background: #222; padding: 10px; border-radius: 8px;
        }

        .btn {
            padding: 10px 20px; background: #fff; color: #000; border: none;
            font-weight: bold; cursor: pointer; text-transform: uppercase;
            font-family: 'Special Elite', cursive; transition: 0.2s;
        }
        .btn:hover { background: #ccc; }
        .btn-pdf { background: #d32f2f; color: white; }
        .btn-pdf:hover { background: #b71c1c; }

        /* A FOLHA A4 */
        .sheet {
            width: 210mm;
            min-height: 297mm;
            background-color: var(--paper-bg);
            color: var(--ink-color);
            padding: 10mm;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            border: 1px solid #ccc;
        }

        /* TIPOGRAFIA */
        h1, h2, h3, .section-header {
            margin: 0; text-transform: uppercase;
            font-family: 'Special Elite', cursive;
        }

        label {
            font-weight: bold; font-size: 0.7rem; text-transform: uppercase;
            display: block; margin-bottom: 2px; letter-spacing: 0.5px;
        }

        input, select, textarea {
            border: none; background: transparent;
            border-bottom: 1px solid #000;
            width: 100%; font-family: 'Roboto Condensed', sans-serif;
            font-size: 1rem; color: #000; padding: 2px 5px; outline: none;
        }
        input:focus, textarea:focus { background: rgba(0,0,0,0.05); }

        /* HEADER */
        .header {
            display: flex; justify-content: space-between; align-items: flex-end;
            border-bottom: 3px solid black; padding-bottom: 10px; margin-bottom: 15px;
        }
        .logo { font-size: 2.5rem; line-height: 0.9; letter-spacing: -1px; }
        .logo span { display: block; font-size: 0.4em; letter-spacing: 5px; }

        /* GRIDS */
        .info-grid {
            display: grid; grid-template-columns: repeat(12, 1fr);
            gap: 10px 15px; margin-bottom: 10px;
            border: 2px solid black; padding: 10px;
        }
        .field { display: flex; flex-direction: column; }
        .span-2 { grid-column: span 2; }
        .span-3 { grid-column: span 3; }
        .span-4 { grid-column: span 4; }
        .span-6 { grid-column: span 6; }
        .span-12 { grid-column: span 12; }

        /* LAYOUT PRINCIPAL */
        .main-layout {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;
        }
        .left-col { display: flex; flex-direction: column; gap: 20px; }
        .right-col { border: 2px solid black; padding: 10px; display: flex; flex-direction: column; }

        /* FOTO */
        .photo-area {
            width: 100%; height: 200px; border: 2px solid black;
            background: #eee; position: relative; overflow: hidden;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .photo-area img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .photo-placeholder { text-align: center; font-size: 0.8rem; color: #666; pointer-events: none; }

        /* PENTAGRAMA */
        .attributes-container {
            position: relative; width: 100%; height: 300px;
            display: flex; justify-content: center; align-items: center;
        }
        .pentagram-svg { position: absolute; width: 250px; height: 250px; z-index: 0; pointer-events: none; }
        .pentagram-svg line, .pentagram-svg polygon { stroke: #000; stroke-width: 2; fill: none; }

        .attr-input {
            position: absolute; width: 70px; height: 70px;
            background: white; border: 2px solid black; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .attr-input label { font-size: 0.9rem; margin: 0; font-weight: 800; }
        .attr-input input { 
            border: none; text-align: center; font-size: 2.2rem; font-weight: 900; 
            width: 100%; height: 100%; background: transparent; margin-top: -8px;
        }
        .pos-agi { top: 0px; }
        .pos-for { top: 90px; left: 0px; }
        .pos-int { top: 90px; right: 0px; }
        .pos-pre { bottom: 40px; left: 30px; }
        .pos-vig { bottom: 40px; right: 30px; }

        /* STATUS */
        .status-block { border: 2px solid black; padding: 5px; margin-bottom: 5px;}
        .status-header { background: black; color: white; padding: 2px 5px; font-weight: bold; display: flex; justify-content: space-between; }
        .status-row { display: flex; justify-content: space-between; margin-top: 5px; }
        .status-input-group { width: 48%; text-align: center; }

        /* DEFESA */
        .defense-box { border: 2px solid black; padding: 10px; text-align: center; background: #fff; }
        .defense-big { font-size: 2.5rem; font-weight: bold; display: block; line-height: 1; }
        .resistencia-box { margin-top: 10px; border-top: 2px solid black; padding-top: 5px; text-align: left; }
        .resistencia-box textarea { width: 100%; height: 40px; border: 1px solid #aaa; resize: none; font-size: 0.8rem; }

        /* PER√çCIAS */
        .skills-header { text-align: center; background: black; color: white; font-weight: bold; padding: 5px; text-transform: uppercase; margin-bottom: 10px; }
        .skill-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; padding: 2px 0; font-size: 0.9rem; }
        .skill-name { flex: 1; font-weight: bold; text-transform: uppercase; font-size: 0.85rem;}
        .skill-attr { font-size: 0.7rem; color: #555; width: 30px; }
        .skill-bonus { width: 40px; text-align: center; border-bottom: 1px solid #aaa; }
        .skill-training { width: 60px; font-size: 0.8rem; border: none; background: transparent; text-align: right; }
        .dice-btn { background: none; border: 1px solid #000; border-radius: 50%; width: 20px; height: 20px; font-size: 0.7rem; cursor: pointer; margin-left: 5px; display: flex; align-items: center; justify-content: center; }
        .dice-btn:hover { background: #000; color: #fff; }

        /* TABELAS */
        .table-section { width: 100%; border: 2px solid black; margin-top: 15px; display: flex; flex-direction: column; }
        .section-header { background: black; color: white; font-weight: bold; padding: 5px; text-align: center; }
        .custom-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .custom-table th { background: #ddd; border: 1px solid black; padding: 2px 5px; font-size: 0.7rem; text-transform: uppercase; }
        .custom-table td { border: 1px solid black; height: 30px; padding: 0; background: white; }
        .custom-table input { width: 100%; height: 100%; border: none; padding: 0 5px; }

        /* NOVA SE√á√ÉO DE HIST√ìRICO/DESCRI√á√ÉO */
        .description-grid {
            padding: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .desc-box textarea {
            width: 100%;
            border: 1px solid #aaa;
            background: repeating-linear-gradient(transparent, transparent 19px, #eee 20px);
            line-height: 20px;
            padding: 0 5px;
            font-size: 0.9rem;
            resize: none;
        }

        .full-width { grid-column: span 2; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 20px; border: 3px solid black; text-align: center; width: 300px; }
        .result-big { font-size: 3rem; font-weight: bold; margin: 10px 0; }
    </style>
</head>
<body>

<!-- BARRA DE A√á√ïES -->
<div class="control-bar" data-html2canvas-ignore="true">
    <button class="btn" onclick="salvarLocal()">Salvar</button>
    <button class="btn" onclick="carregarLocal()">Carregar</button>
    <button class="btn btn-pdf" onclick="gerarPDF()">Baixar PDF</button>
</div>

<!-- FOLHA A4 -->
<div class="sheet" id="ficha-content">
    
    <!-- Header -->
    <div class="header">
        <div class="logo">
            ORDEM <span>PARANORMAL</span>
        </div>
        <div style="text-align: right; font-family: 'Special Elite'; font-size: 0.9rem;">
            DOSSI√ä DE AGENTE<br>CONFIDENCIAL
        </div>
    </div>

    <!-- Info B√°sica -->
    <div class="info-grid">
        <div class="field span-6">
            <label>Personagem</label> <input type="text" id="personagem">
        </div>
        <div class="field span-6">
            <label>Jogador</label> <input type="text" id="jogador">
        </div>
        <div class="field span-4">
            <label>Origem</label> <input type="text" id="origem">
        </div>
        <div class="field span-4">
            <label>Classe</label>
            <select id="classe" style="border-bottom: 1px solid black;">
                <option value="">--</option>
                <option value="Combatente">Combatente</option>
                <option value="Especialista">Especialista</option>
                <option value="Ocultista">Ocultista</option>
            </select>
        </div>
        <div class="field span-2">
            <label>NEX %</label> <input type="number" id="nex">
        </div>
        <div class="field span-2">
            <label>Desl.</label> <input type="number" id="deslocamento">
        </div>
        <!-- Adicionado Patente/Prest√≠gio conforme o texto -->
        <div class="field span-4">
            <label>Patente</label> <input type="text" id="patente">
        </div>
        <div class="field span-4">
            <label>Pontos de Prest√≠gio</label> <input type="text" id="prestigio">
        </div>
        <div class="field span-4">
            <label>Limite de Cr√©dito</label> <input type="text" id="credito">
        </div>
    </div>

    <div class="main-layout">
        <!-- Esquerda -->
        <div class="left-col">
            <div class="photo-area" onclick="document.getElementById('upload-foto').click()">
                <div class="photo-placeholder" id="placeholder-text">FOTO DO AGENTE<br>(Clique)</div>
                <img id="img-preview" alt="Foto">
                <input type="file" id="upload-foto" accept="image/*" style="display:none" onchange="previewImagem(this)">
            </div>

            <!-- Pentagrama -->
            <div class="attributes-container">
                <svg class="pentagram-svg" viewBox="0 0 200 200">
                    <polygon points="100,10  190,75  155,180  45,180  10,75" stroke="black" fill="none" stroke-width="2"/>
                    <line x1="100" y1="10" x2="155" y2="180" />
                    <line x1="100" y1="10" x2="45" y2="180" />
                    <line x1="190" y1="75" x2="45" y2="180" />
                    <line x1="190" y1="75" x2="10" y2="75" />
                    <line x1="155" y1="180" x2="10" y2="75" />
                </svg>

                <div class="attr-input pos-agi"><label>AGI</label><input type="number" id="attr-agi" value="1" onchange="atualizaBonus()"></div>
                <div class="attr-input pos-int"><label>INT</label><input type="number" id="attr-int" value="1" onchange="atualizaBonus()"></div>
                <div class="attr-input pos-vig"><label>VIG</label><input type="number" id="attr-vig" value="1" onchange="atualizaBonus()"></div>
                <div class="attr-input pos-pre"><label>PRE</label><input type="number" id="attr-pre" value="1" onchange="atualizaBonus()"></div>
                <div class="attr-input pos-for"><label>FOR</label><input type="number" id="attr-for" value="1" onchange="atualizaBonus()"></div>
            </div>

            <!-- Status -->
            <div class="status-block">
                <div class="status-header"><span>PONTOS DE VIDA (PV)</span></div>
                <div class="status-row">
                    <div class="status-input-group"><label>M√ÅX</label><input type="number" id="pv-max"></div>
                    <div class="status-input-group"><label>ATUAL</label><input type="number" id="pv-atual"></div>
                </div>
            </div>
            <div class="status-block">
                <div class="status-header"><span>SANIDADE (SAN)</span></div>
                <div class="status-row">
                    <div class="status-input-group"><label>M√ÅX</label><input type="number" id="san-max"></div>
                    <div class="status-input-group"><label>ATUAL</label><input type="number" id="san-atual"></div>
                </div>
            </div>
            <div class="status-block">
                <div class="status-header"><span>PONTOS DE ESFOR√áO (PE)</span></div>
                <div class="status-row">
                    <div class="status-input-group"><label>M√ÅX</label><input type="number" id="pe-max"></div>
                    <div class="status-input-group"><label>ATUAL</label><input type="number" id="pe-atual"></div>
                </div>
            </div>

            <!-- Defesa -->
            <div class="defense-box">
                <h3>DEFESA</h3>
                <span id="defesa-total" class="defense-big">10</span>
                <div style="font-size: 0.8rem; margin-top: 5px;">
                    10 + <span id="bonus-agi">1</span> (AGI) + <input type="number" id="bonus-equip" value="0" style="width: 30px; border-bottom: 1px solid black; text-align: center;" onchange="calculaDefesa()"> (Equip)
                </div>
                <div class="resistencia-box">
                    <label>RESIST√äNCIAS / PROTE√á√ÉO</label>
                    <textarea id="resistencias" placeholder="Ex: Mental 5, Bal√≠stico 2..."></textarea>
                </div>
            </div>
        </div>

        <!-- Direita: Per√≠cias -->
        <div class="right-col">
            <div class="skills-header">PER√çCIAS</div>
            <div id="skills-list"></div>
        </div>
    </div>

    <!-- Ataques -->
    <div class="table-section">
        <div class="section-header">ATAQUES</div>
        <table class="custom-table">
            <thead>
                <tr>
                    <th style="width: 30%;">ATAQUE</th>
                    <th style="width: 15%;">TESTE</th>
                    <th style="width: 15%;">DANO</th>
                    <th style="width: 40%;">CR√çTICO / ALCANCE / ESPECIAL</th>
                </tr>
            </thead>
            <tbody>
                <tr><td><input type="text" id="atk-nome-1"></td><td><input type="text" id="atk-teste-1"></td><td><input type="text" id="atk-dano-1"></td><td><input type="text" id="atk-crit-1"></td></tr>
                <tr><td><input type="text" id="atk-nome-2"></td><td><input type="text" id="atk-teste-2"></td><td><input type="text" id="atk-dano-2"></td><td><input type="text" id="atk-crit-2"></td></tr>
                <tr><td><input type="text" id="atk-nome-3"></td><td><input type="text" id="atk-teste-3"></td><td><input type="text" id="atk-dano-3"></td><td><input type="text" id="atk-crit-3"></td></tr>
                <tr><td><input type="text" id="atk-nome-4"></td><td><input type="text" id="atk-teste-4"></td><td><input type="text" id="atk-dano-4"></td><td><input type="text" id="atk-crit-4"></td></tr>
            </tbody>
        </table>
    </div>

    <!-- Habilidades -->
    <div class="table-section">
        <div class="section-header">HABILIDADES & RITUAIS</div>
        <table class="custom-table">
            <thead>
                <tr>
                    <th style="width: 25%;">NOME</th>
                    <th style="width: 10%;">CUSTO</th>
                    <th style="width: 45%;">DESCRITIVO</th>
                    <th style="width: 10%;">DT</th>
                </tr>
            </thead>
            <tbody>
                <tr><td><input type="text" id="hab-nome-1"></td><td><input type="text" id="hab-custo-1"></td><td><input type="text" id="hab-desc-1"></td><td><input type="text" id="hab-dt-1"></td></tr>
                <tr><td><input type="text" id="hab-nome-2"></td><td><input type="text" id="hab-custo-2"></td><td><input type="text" id="hab-desc-2"></td><td><input type="text" id="hab-dt-2"></td></tr>
                <tr><td><input type="text" id="hab-nome-3"></td><td><input type="text" id="hab-custo-3"></td><td><input type="text" id="hab-desc-3"></td><td><input type="text" id="hab-dt-3"></td></tr>
                <tr><td><input type="text" id="hab-nome-4"></td><td><input type="text" id="hab-custo-4"></td><td><input type="text" id="hab-desc-4"></td><td><input type="text" id="hab-dt-4"></td></tr>
                <tr><td><input type="text" id="hab-nome-5"></td><td><input type="text" id="hab-custo-5"></td><td><input type="text" id="hab-desc-5"></td><td><input type="text" id="hab-dt-5"></td></tr>
            </tbody>
        </table>
    </div>

    <!-- NOVA SE√á√ÉO: DADOS PESSOAIS E HIST√ìRICO -->
    <div class="table-section">
        <div class="section-header">DADOS PESSOAIS & HIST√ìRICO</div>
        <div class="description-grid">
            <div class="desc-box">
                <label>APAR√äNCIA</label>
                <textarea id="desc-aparencia" rows="3"></textarea>
            </div>
            <div class="desc-box">
                <label>PERSONALIDADE</label>
                <textarea id="desc-personalidade" rows="3"></textarea>
            </div>
            <div class="desc-box full-width">
                <label>HIST√ìRICO</label>
                <textarea id="desc-historico" rows="5"></textarea>
            </div>
            <div class="desc-box">
                <label>OBJETIVO</label>
                <textarea id="desc-objetivo" rows="2"></textarea>
            </div>
            <div class="desc-box">
                <!-- "Calita" parece ser um termo espec√≠fico ou typo para Caracter√≠sticas/Cicatrizes, deixei como "Caracter√≠sticas/Outros" -->
                <label>CARACTER√çSTICAS / MARCAS</label>
                <textarea id="desc-outros" rows="2"></textarea>
            </div>
        </div>
    </div>

    <!-- Invent√°rio -->
    <div class="table-section" style="margin-top: 15px;">
        <div class="section-header">INVENT√ÅRIO</div>
        <div style="padding: 10px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <div style="width:30%"><label>ITEM</label></div>
                <div style="width:20%"><label>CATEGORIA</label></div>
                <div style="width:10%"><label>ESPA√áO</label></div>
            </div>
            <textarea id="inventario" style="height: 100px; resize: none; border: 1px solid #aaa; font-family: 'Roboto Condensed'; width: 100%; background: repeating-linear-gradient(transparent, transparent 19px, #eee 20px); line-height: 20px;"></textarea>
            <div style="margin-top:5px; display:flex; gap:10px;">
                <div><label>CARGA M√ÅX.</label><input type="number" id="carga-max" style="width:50px; text-align:center; border-bottom:1px solid #000;"></div>
            </div>
        </div>
    </div>

</div>

<!-- MODAL RESULTADO -->
<div id="modal-roll" class="modal" onclick="this.style.display='none'">
    <div class="modal-box" onclick="event.stopPropagation()">
        <h2>RESULTADO</h2>
        <div id="roll-details" style="color: #666; font-size: 0.9rem;"></div>
        <div id="roll-result" class="result-big">20</div>
        <button class="btn" onclick="document.getElementById('modal-roll').style.display='none'">Fechar</button>
    </div>
</div>

<script>
    const pericias = [
        {nome: "Acrobacia", attr: "agi"}, {nome: "Adestramento", attr: "pre"}, {nome: "Artes", attr: "pre"},
        {nome: "Atletismo", attr: "for"}, {nome: "Atualidades", attr: "int"}, {nome: "Ci√™ncias", attr: "int"},
        {nome: "Crime", attr: "agi"}, {nome: "Diplomacia", attr: "pre"}, {nome: "Engana√ß√£o", attr: "pre"},
        {nome: "Fortitude", attr: "vig"}, {nome: "Furtividade", attr: "agi"}, {nome: "Iniciativa", attr: "agi"},
        {nome: "Intimida√ß√£o", attr: "pre"}, {nome: "Intui√ß√£o", attr: "int"}, {nome: "Investiga√ß√£o", attr: "int"},
        {nome: "Luta", attr: "for"}, {nome: "Medicina", attr: "int"}, {nome: "Ocultismo", attr: "int"},
        {nome: "Percep√ß√£o", attr: "pre"}, {nome: "Pilotagem", attr: "agi"}, {nome: "Pontaria", attr: "agi"},
        {nome: "Reflexos", attr: "agi"}, {nome: "Religi√£o", attr: "pre"}, {nome: "Sobreviv√™ncia", attr: "int"},
        {nome: "T√°tica", attr: "int"}, {nome: "Tecnologia", attr: "int"}, {nome: "Vontade", attr: "pre"}
    ];

    function init() {
        const container = document.getElementById('skills-list');
        pericias.forEach(p => {
            const row = document.createElement('div');
            row.className = 'skill-row';
            row.innerHTML = `
                <button class="dice-btn" onclick="rolar('${p.attr}', '${p.nome}')" data-html2canvas-ignore="true">üé≤</button>
                <span class="skill-name" style="margin-left: 5px;">${p.nome}</span>
                <span class="skill-attr">(${p.attr.toUpperCase()})</span>
                <select class="skill-training" id="grau-${p.nome}" onchange="atualizaRolagem()">
                    <option value="0">destreinado</option>
                    <option value="5">treinado</option>
                    <option value="10">veterano</option>
                    <option value="15">expert</option>
                </select>
                <input type="number" class="skill-bonus" id="bonus-${p.nome}" value="0">
            `;
            container.appendChild(row);
        });
        calculaDefesa();
    }

    function atualizaBonus() { calculaDefesa(); }

    function calculaDefesa() {
        const agi = parseInt(document.getElementById('attr-agi').value) || 0;
        const equip = parseInt(document.getElementById('bonus-equip').value) || 0;
        document.getElementById('bonus-agi').innerText = agi;
        document.getElementById('defesa-total').innerText = 10 + agi + equip;
    }

    function rolar(attr, periciaNome) {
        const dados = parseInt(document.getElementById(`attr-${attr}`).value) || 0;
        const grau = parseInt(document.getElementById(`grau-${periciaNome}`).value) || 0;
        const outros = parseInt(document.getElementById(`bonus-${periciaNome}`).value) || 0;
        const bonusTotal = grau + outros;

        let rolagens = [];
        let resultadoDado = 0;

        if (dados <= 0) {
            rolagens.push(d20(), d20());
            resultadoDado = Math.min(...rolagens);
        } else {
            for(let i=0; i<dados; i++) rolagens.push(d20());
            resultadoDado = Math.max(...rolagens);
        }

        const final = resultadoDado + bonusTotal;
        const modal = document.getElementById('modal-roll');
        document.getElementById('roll-details').innerText = `${periciaNome.toUpperCase()}: [${rolagens.join(', ')}] -> ${resultadoDado} + ${bonusTotal}`;
        document.getElementById('roll-result').innerText = final;
        modal.style.display = 'flex';
    }

    function d20() { return Math.floor(Math.random() * 20) + 1; }

    function previewImagem(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('img-preview').src = e.target.result;
                document.getElementById('img-preview').style.display = 'block';
                document.getElementById('placeholder-text').style.display = 'none';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function gerarPDF() {
        const element = document.getElementById('ficha-content');
        const nome = document.getElementById('personagem').value || 'Agente';
        const opt = {
            margin: 0,
            filename: `Dossie_${nome}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        const btn = document.querySelector('.btn-pdf');
        const oldText = btn.innerText;
        btn.innerText = "GERANDO...";
        html2pdf().set(opt).from(element).save().then(() => { btn.innerText = oldText; });
    }

    function salvarLocal() {
        const inputs = document.querySelectorAll('input, select, textarea');
        const data = {};
        inputs.forEach(el => {
            if(el.id && el.type !== 'file') data[el.id] = el.value;
        });
        const img = document.getElementById('img-preview');
        if(img.src && img.style.display !== 'none') data['foto_src'] = img.src;
        localStorage.setItem('ficha_ordem_v2', JSON.stringify(data));
        alert('Dossi√™ Salvo!');
    }

    function carregarLocal() {
        const data = JSON.parse(localStorage.getItem('ficha_ordem_v2'));
        if(!data) return alert('Nenhum dossi√™ encontrado!');
        Object.keys(data).forEach(k => {
            const el = document.getElementById(k);
            if(el) el.value = data[k];
        });
        if(data['foto_src']) {
            const img = document.getElementById('img-preview');
            img.src = data['foto_src'];
            img.style.display = 'block';
            document.getElementById('placeholder-text').style.display = 'none';
        }
        calculaDefesa();
    }

    init();
</script>

</body>
</html>
